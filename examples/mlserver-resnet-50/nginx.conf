upstream mlserver_backend {
    server localhost:8080 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

server {  
    listen 80;  
    server_name 0.0.0.0;

    proxy_set_header Host $host;  
    proxy_set_header X-Real-IP $remote_addr;  
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  
    proxy_set_header X-Forwarded-Proto $scheme;

    location = / {
        return 301 $scheme://$host/;
    }

    location ~^/system/services/([^/]+)/exposed$ {  
        return 301 $scheme://$host/system/services/$1/exposed/v2;  
    }  

    location ~^/system/services/([^/]+)/exposed/v2/docs$ {  
        rewrite ^/system/services/([^/]+)/exposed/v2/docs$ /v2/docs break;
        proxy_pass http://mlserver_backend;

        proxy_set_header Accept-Encoding "";
        sub_filter_once off;

        # Modify Swagger UI to point to updated JSON location
        sub_filter "url: '/v2/docs/dataplane.json'" "url: '/system/services/$1/exposed/v2/docs/dataplane.json'";
    }  
    
    location ~^/system/services/([^/]+)/exposed/v2/docs/dataplane.json$ {
        rewrite ^/system/services/([^/]+)/exposed/v2/docs/dataplane.json$ /v2/docs/dataplane.json break;
        proxy_pass http://mlserver_backend;

        proxy_set_header Accept-Encoding "";

        sub_filter_types application/json;
        sub_filter_once off;

        # Replace empty servers array in OpenAPI JSON
        sub_filter '"servers":[]' '"servers":[{"url":"https://$host/system/services/$1/exposed/","description":"Remote host"}]';
    }

    location ~^/system/services/([^/]+)/exposed/v2/models/([^/]+)/docs$ {  
        proxy_pass http://mlserver_backend/v2/models/$2/docs;

        proxy_set_header Accept-Encoding "";
        sub_filter_once off;

        # Modify Swagger UI to point to updated JSON location
        sub_filter "url: '/v2/models/$2/docs/dataplane.json'" "url: '/system/services/$1/exposed/v2/models/$2/docs/dataplane.json'";
    }  
    
    location ~^/system/services/([^/]+)/exposed/v2/models/([^/]+)/docs/dataplane.json$ {
        proxy_pass http://mlserver_backend/v2/models/$2/docs/dataplane.json;

        proxy_set_header Accept-Encoding "";

        sub_filter_types application/json;
        sub_filter_once off;

        # Replace empty servers array in OpenAPI JSON
        sub_filter '"servers":[]' '"servers":[{"url":"https://$host/system/services/$1/exposed/","description":"Remote host"}]';
    }

    # Proxy all other requests to the backend
    location ~^/system/services/([^/]+)/exposed/(.*)$ {
        rewrite ^/system/services/([^/]+)/exposed/(.*)$ /$2 break;
        proxy_pass http://mlserver_backend;
    }  
    
    # Deny access to hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}
