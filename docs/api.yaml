openapi: 3.0.3
info:
  title: OSCAR API
  version: v2.0.0
  license:
    name: Apache 2.0
    url: 'https://www.apache.org/licenses/LICENSE-2.0'
  description: OSCAR API documentation
  contact:
    name: GRyCAP
    email: products@grycap.upv.es
externalDocs:
  description: More documentation available on GitHub
  url: 'https://github.com/grycap/oscar'
paths:
  /system/services:
    get:
      summary: List services
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Service'
        '401':
          description: Unauthorized
        '500':
          description: Internal Server Error
      operationId: ListServices
      description: List all created services
      security:
        - basicAuth: []
        - token: []
      tags:
        - services
    post:
      summary: Create service
      operationId: CreateService
      responses:
        '201':
          description: Created
        '400':
          description: Bad Request
        '401':
          description: Unauthorized
        '500':
          description: Internal Server Error
      description: Create a service
      security:
        - basicAuth: []
        - token: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Service'
      tags:
        - services
    put:
      summary: Update service
      operationId: UpdateService
      responses:
        '204':
          description: No Content
        '400':
          description: Bad Request
        '401':
          description: Unauthorized
        '404':
          description: Not Found
        '500':
          description: Internal Server Error
      description: Update a service
      security:
        - basicAuth: []
        - token: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Service'
      tags:
        - services
  '/system/services/{serviceName}':
    parameters:
      - schema:
          type: string
        name: serviceName
        in: path
        required: true
    get:
      summary: Read service
      tags:
        - services
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Service'
        '401':
          description: Unauthorized
        '404':
          description: Not Found
        '500':
          description: Internal Server Error
      operationId: ReadService
      security:
        - basicAuth: []
        - token: []
      description: Read a service
    delete:
      summary: Delete service
      operationId: DeleteService
      responses:
        '204':
          description: No Content
        '401':
          description: Unauthorized
        '404':
          description: Not Found
        '500':
          description: Internal Server Error
      description: Delete a service
      security:
        - basicAuth: []
        - token: []
      tags:
        - services
  '/system/logs/{serviceName}':
    parameters:
      - schema:
          type: string
        name: serviceName
        in: path
        required: true
      - in: query
        name: page
        schema:
          type: string
        description: Continuation token returned by a previous request.
    get:
      summary: List jobs
      tags:
        - logs
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobsResponse'
        '401':
          description: Unauthorized
        '404':
          description: Not Found
        '500':
          description: Internal Server Error
      operationId: ListJobs
      security:
        - basicAuth: []
        - token: []
      description: List all jobs with their status
    delete:
      summary: Delete jobs
      operationId: DeleteJobs
      responses:
        '204':
          description: No Content
        '401':
          description: Unauthorized
        '404':
          description: Not Found
        '500':
          description: Internal Server Error
      description: Delete all jobs from a service.
      security:
        - basicAuth: []
        - token: []
      parameters:
        - schema:
            type: boolean
          in: query
          name: all
          description: 'If "all" is true delete pending, running and failed jobs, else delete only completed jobs (default: false)'
      tags:
        - logs
  '/system/logs/{serviceName}/{jobName}':
    parameters:
      - schema:
          type: string
        name: serviceName
        in: path
        required: true
      - schema:
          type: string
        name: jobName
        in: path
        required: true
    get:
      summary: Get logs
      tags:
        - logs
      responses:
        '200':
          description: OK
          content:
            text/plain:
              schema:
                type: string
        '401':
          description: Unauthorized
        '404':
          description: Not Found
        '500':
          description: Internal Server Error
      operationId: GetJobLogs
      description: Get the logs from a job
      security:
        - basicAuth: []
        - token: []
      parameters:
        - schema:
            type: boolean
          in: query
          name: timestamps
    delete:
      summary: Delete job
      operationId: DeleteJob
      responses:
        '204':
          description: No Content
        '401':
          description: Unauthorized
        '404':
          description: Not Found
        '500':
          description: Internal Server Error
      description: Delete a job
      security:
        - basicAuth: []
        - token: []
      tags:
        - logs
  /system/info:
    get:
      summary: Get info
      tags:
        - info
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Info'
        '401':
          description: Unauthorized
        '500':
          description: Internal Server Error
      operationId: GetInfo
      description: Get system info
      security:
        - basicAuth: []
        - token: []
  /health:
    get:
      summary: Health
      tags:
        - health
      responses:
        '200':
          description: OK
      operationId: HealthCheck
      description: Health check
  '/job/{serviceName}':
    parameters:
      - schema:
          type: string
        name: serviceName
        in: path
        required: true
    post:
      summary: Invoke service (async)
      operationId: InvokeAsync
      responses:
        '201':
          description: Created
        '404':
          description: Not Found
        '500':
          description: Internal Server Error
      tags:
        - async
      security:
        - token: []
      description: Invoke a service asynchronously (create kubernetes job)
      requestBody:
        content:
          application/octet-stream:
            schema:
              type: string
              format: binary
          application/json:
            schema:
              type: string
        description: Event payload forwarded to the service
  /system/config:
    get:
      summary: Get OSCAR configuration
      tags:
        - config
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigForUser'
        '401':
          description: Unauthorized
        '500':
          description: Internal Server Error
      operationId: GetConfig
      description: Get system configuration
      security:
        - basicAuth: []
        - token: []
  '/run/{serviceName}':
    parameters:
      - schema:
          type: string
        name: serviceName
        in: path
        required: true
    post:
      summary: Invoke service (sync)
      responses:
        '200':
          description: OK
        '400':
          description: Bad Request
        '401':
          description: Unauthorized
        '404':
          description: Not Found
        '500':
          description: Internal Server Error
      operationId: InvokeSync
      tags:
        - sync
      security:
        - token: []
      description: Invoke a service synchronously (a Serverless backend is required)
      requestBody:
        content:
          application/octet-stream:
            schema:
              type: string
              format: binary
          application/json:
            schema:
              type: string
        description: Event payload forwarded to the service
  /system/buckets:
    get:
      summary: List buckets
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/BucketSummary'
        '401':
          description: Unauthorized
        '500':
          description: Internal Server Error
      operationId: ListBuckets
      description: List all buckets visible for the user
      security:
        - basicAuth: []
        - token: []
      tags:
        - buckets
    post:
      summary: Create bucket
      operationId: CreateBucket
      responses:
        '201':
          description: Bucket created
        '400':
          description: Bad Request
        '401':
          description: Unauthorized
        '500':
          description: Internal Server Error
      description: Create a independent bucket
      security:
        - basicAuth: []
        - token: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BucketSummary'
      tags:
        - buckets        
    put:
      summary: Update bucket
      operationId: UpdateBucket
      responses:
        '204':
          description: Bucket updated
        '400':
          description: Bad Request
        '401':
          description: Unauthorized
        '404':
          description: Not Found
        '500':
          description: Internal Server Error
      description: Update a specific bucket
      security:
        - basicAuth: []
        - token: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BucketSummary'
      tags:
        - buckets
  '/system/buckets/{bucket}':
    parameters:
      - schema:
          type: string
        name: bucket
        in: path
        required: true
      - in: query
        name: page
        schema:
          type: string
        description: Continuation token returned by a previous request.
    get:
      summary: Get bucket details
      operationId: GetBucket
      responses:
        '200':
          description: Bucket details retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BucketDetails'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not Found
        '500':
          description: Internal Server Error
      description: Retrieve metadata and object listing for a specific bucket
      security:
        - basicAuth: []
        - token: []
      tags:
        - buckets
    delete:
      summary: Delete bucket
      operationId: DeleteBucket
      responses:
        '204':
          description: Bucket deleted
        '401':
          description: Unauthorized
        '404':
          description: Not Found
        '500':
          description: Internal Server Error
      description: Delete a specific bucket
      security:
        - basicAuth: []
        - token: []
      tags:
        - buckets
  '/system/buckets/{bucket}/presign':
    parameters:
      - schema:
          type: string
        name: bucket
        in: path
        required: true
    post:
      summary: Generate presigned object URL
      operationId: PresignBucketObject
      description: Create a short-lived MinIO presigned URL to upload or download an object within the bucket.
      tags:
        - buckets
      security:
        - basicAuth: []
        - token: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BucketPresignRequest'
      responses:
        '200':
          description: Presigned URL generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BucketPresignResponse'
        '400':
          description: Bad Request
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not Found
        '500':
          description: Internal Server Error
  '/system/status':
    get:
      summary: Get OSCAR and cluster status
      tags:
        - status
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusInfo'
        '401':
          description: Unauthorized
        '500':
          description: Internal Server Error
      operationId: Status
      description: Get cluster status
      security:
        - basicAuth: []
        - token: []
components:
  schemas:
    Service:
      title: Service
      type: object
      properties:
        name:
          type: string
        cluster_id:
          type: string
        memory:
          type: string
        cpu:
          type: string
        total_memory:
          type: string
        total_cpu:
          type: string
        enable_gpu:
          type: boolean
          default: false
        enable_sgx:
          type: boolean
          default: false
        image_prefetch:
          type: boolean
          default: false
        synchronous:
          type: object
          properties:
            min_scale:
              type: integer
            max_scale:
              type: integer
        replicas:
          type: array
          items:
            $ref: '#/components/schemas/Replica'
        delegation:
          type: string
          description: Replica delegation mode (static, random, load-based)
        rescheduler_threshold:
          type: integer
        log_level:
          type: string
        image:
          type: string
        alpine:
          type: boolean
          default: false
        token:
          type: string
          readOnly: true
        file_stage_in:
          type: boolean
        input:
          type: array
          items:
            $ref: '#/components/schemas/StorageIOConfig'
        output:
          type: array
          items:
            $ref: '#/components/schemas/StorageIOConfig'
        script:
          type: string
        image_pull_secrets:
          type: array
          items:
            type: string
        expose:
          $ref: '#/components/schemas/ExposeSettings'
        environment:
          $ref: '#/components/schemas/EnvironmentConfig'
        annotations:
          type: object
          additionalProperties:
            type: string
        vo:
          type: string
        labels:
          type: object
          additionalProperties:
            type: string
        storage_providers:
          $ref: '#/components/schemas/StorageProviders'
        clusters:
          $ref: '#/components/schemas/Clusters'
        owner:
          type: string
        interlink_node_name:
          type: string
        visibility:
          type: string
          enum:
            - private
            - public
            - restricted
        allowed_users:
          type: array
          items:
            type: string
        isolation_level:
          type: string
        bucket_list:
          type: array
          items:
            type: string
        mount:
          $ref: '#/components/schemas/StorageIOConfig'
      required:
        - name
        - image
        - script
    StorageIOConfig:
      title: StorageIOConfig
      type: object
      properties:
        storage_provider:
          type: string
        path:
          type: string
        suffix:
          type: array
          items:
            type: string
        prefix:
          type: array
          items:
            type: string
    StorageProviders:
      title: StorageProviders
      type: object
      properties:
        s3:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/S3Provider'
        minio:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/MinIOProvider'
        onedata:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/OnedataProvider'
        webdav:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/WebDavProvider'
        rucio:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/RucioProvider'
    S3Provider:
      title: S3Provider
      type: object
      properties:
        access_key:
          type: string
        secret_key:
          type: string
        region:
          type: string
    BucketSummary:
      title: BucketSummary
      type: object
      properties:
        bucket_name:
          type: string
        visibility:
          type: string
        allowed_users:
          type: array
          items:
            type: string
        owner:
          type: string
        metadata:
          type: object
          additionalProperties:
            type: string
    BucketDetails:
      allOf:
        - $ref: '#/components/schemas/BucketSummary'
        - type: object
          properties:
            objects:
              type: array
              items:
                $ref: '#/components/schemas/BucketObject'
            next_page:
              type: string
            is_truncated:
              type: boolean
            returned_items:
              type: integer
    BucketObject:
      title: BucketObject
      type: object
      properties:
        object_name:
          type: string
        size_bytes:
          type: integer
          format: int64
        last_modified:
          type: string
          format: date-time
    BucketPresignRequest:
      title: BucketPresignRequest
      type: object
      properties:
        object_key:
          type: string
        operation:
          type: string
          enum:
            - upload
            - download
        expires_in:
          type: integer
          format: int64
          description: Requested expiration time in seconds for the presigned URL.
        content_type:
          type: string
        extra_headers:
          type: object
          additionalProperties:
            type: string
      required:
        - object_key
        - operation
    BucketPresignResponse:
      title: BucketPresignResponse
      type: object
      properties:
        object_key:
          type: string
        operation:
          type: string
          enum:
            - upload
            - download
        method:
          type: string
        url:
          type: string
          format: uri
        expires_at:
          type: string
          format: date-time
        headers:
          type: object
          additionalProperties:
            type: string
      required:
        - object_key
        - operation
        - method
        - url
        - expires_at
    Clusters:
      title: Clusters
      type: object
      additionalProperties:
        $ref: '#/components/schemas/Cluster'
    Cluster:
      title: Cluster
      type: object
      properties:
        endpoint:
          type: string
        auth_user:
          type: string
        auth_password:
          type: string
        ssl_verify:
          type: boolean
    Replica:
      title: Replica
      type: object
      properties:
        type:
          type: string
          enum:
            - oscar
            - endpoint
        cluster_id:
          type: string
        service_name:
          type: string
        url:
          type: string
          format: uri
        ssl_verify:
          type: boolean
          default: true
        priority:
          type: integer
          default: 0
        headers:
          type: object
          additionalProperties:
            type: string
    OnedataProvider:
      title: OnedataProvider
      type: object
      properties:
        oneprovider_host:
          type: string
        token:
          type: string
        space:
          type: string
    WebDavProvider:
      title: WebDavProvider
      type: object
      properties:
        hostname:
          type: string
        login:
          type: string
        password:
          type: string
    RucioProvider:
      title: RucioProvider
      type: object
      properties:
        host:
          type: string
        account:
          type: string
        rse:
          type: string
        refresh_token:
          type: string
        auth_host:
          type: string
        oidc_audience:
          type: string
        token_endpoint:
          type: string
    EnvironmentConfig:
      title: EnvironmentConfig
      type: object
      properties:
        variables:
          type: object
          additionalProperties:
            type: string
        secrets:
          type: object
          additionalProperties:
            type: string
    ExposeSettings:
      title: ExposeSettings
      type: object
      properties:
        min_scale:
          type: integer
        max_scale:
          type: integer
        api_port:
          type: integer
        cpu_threshold:
          type: integer
        rewrite_target:
          type: boolean
        nodePort:
          type: integer
        default_command:
          type: boolean
        set_auth:
          type: boolean
    JobsResponse:
      title: JobsResponse
      type: object
      properties:
        jobs:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/JobInfo'
        next_page:
          type: string
        remaining_jobs:
          type: integer
          format: int64
    JobInfo:
      title: JobInfo
      type: object
      properties:
        status:
          type: string
        creation_time:
          type: string
          format: date-time
        start_time:
          type: string
          format: date-time
        finish_time:
          type: string
          format: date-time
    Info:
      title: Info
      type: object
      properties:
        version:
          type: string
        git_commit:
          type: string
        architecture:
          type: string
        kubernetes_version:
          type: string
        serverless_backend:
          type: object
          properties:
            name:
              type: string
            version:
              type: string
    ConfigForUser:
      title: ConfigForUser
      type: object
      properties:
        config:
          $ref: '#/components/schemas/Config'
        minio_provider:
          $ref: '#/components/schemas/MinIOProvider'
    Config:
      title: Config
      type: object
      properties:
        name:
          type: string
        namespace:
          type: string
        services_namespace:
          type: string
        gpu_available:
          type: boolean
        interLink_available:
          type: boolean
        serverless_backend:
          type: string
        yunikorn_enable:
          type: boolean
        oidc_groups:
          type: array
          items:
            type: string
    MinIOProvider:
      title: MinIOProvider
      type: object
      properties:
        endpoint:
          type: string
        region:
          type: string
        secret_key:
          type: string
        access_key:
          type: string
        verify:
          type: boolean
    StatusInfo:
      title: StatusInfo
      type: object
      properties:
        cluster:
          $ref: '#/components/schemas/ClusterStatus'
        oscar:
          $ref: '#/components/schemas/OscarStatus'
        minio:
          $ref: '#/components/schemas/MinioStatus'
    ClusterStatus:
      title: ClusterStatus
      type: object
      properties:
        nodes_count:
          type: integer
          format: int64
        metrics:
          $ref: '#/components/schemas/ClusterMetrics'
        nodes:
          type: array
          items:
            $ref: '#/components/schemas/NodeDetail'
    ClusterMetrics:
      title: ClusterMetrics
      type: object
      properties:
        cpu:
          $ref: '#/components/schemas/CPUMetrics'
        memory:
          $ref: '#/components/schemas/MemoryMetrics'
        gpu:
          $ref: '#/components/schemas/GPUMetrics'
    CPUMetrics:
      title: CPUMetrics
      type: object
      properties:
        total_free_cores:
          type: integer
          format: int64
        max_free_on_node_cores:
          type: integer
          format: int64
    MemoryMetrics:
      title: MemoryMetrics
      type: object
      properties:
        total_free_bytes:
          type: integer
          format: int64
        max_free_on_node_bytes:
          type: integer
          format: int64
    GPUMetrics:
      title: GPUMetrics
      type: object
      properties:
        total_gpu:
          type: integer
          format: int64
    NodeDetail:
      title: NodeDetail
      type: object
      properties:
        name:
          type: string
        cpu:
          $ref: '#/components/schemas/NodeResource'
        memory:
          $ref: '#/components/schemas/NodeResource'
        gpu:
          type: integer
          format: int64
        is_interlink:
          type: boolean
        status:
          type: string
        conditions:
          type: array
          items:
            $ref: '#/components/schemas/NodeCondition'
    NodeResource:
      title: NodeResource
      type: object
      properties:
        capacity_cores:
          type: integer
          format: int64
        usage_cores:
          type: integer
          format: int64
        capacity_bytes:
          type: integer
          format: int64
        usage_bytes:
          type: integer
          format: int64
    NodeCondition:
      title: NodeCondition
      type: object
      properties:
        type:
          type: string
        status:
          type: boolean
    OscarStatus:
      title: OscarStatus
      type: object
      properties:
        deployment_name:
          type: string
        ready:
          type: boolean
        deployment:
          $ref: '#/components/schemas/OscarDeployment'
        jobs_count:
          type: integer
        pods:
          $ref: '#/components/schemas/PodStates'
        oidc:
          $ref: '#/components/schemas/OIDCInfo'
    OscarDeployment:
      title: OscarDeployment
      type: object
      properties:
        available_replicas:
          type: integer
        ready_replicas:
          type: integer
        replicas:
          type: integer
        creation_timestamp:
          type: string
          format: date-time
        strategy:
          type: string
        labels:
          type: object
          additionalProperties:
            type: string
    PodStates:
      title: PodStates
      type: object
      properties:
        total:
          type: integer
        states:
          type: object
          additionalProperties:
            type: integer
    OIDCInfo:
      title: OIDCInfo
      type: object
      properties:
        enabled:
          type: boolean
        issuers:
          type: array
          items:
            type: string
        groups:
          type: array
          items:
            type: string
    MinioStatus:
      title: MinioStatus
      type: object
      properties:
        buckets_count:
          type: integer
        total_objects:
          type: integer
  securitySchemes:
    basicAuth:
      type: http
      scheme: basic
      description: ''
    token:
      type: http
      scheme: bearer
      description: ''
tags:
  - name: services
  - name: logs
  - name: sync
  - name: async
  - name: info
  - name: health
  - name: status
  - name: config
  - name: buckets
servers:
  - url: 'https://localhost'
    description: 'Local testing'
  - url: 'https://inference.cloud.ai4eosc.eu'
    description: 'AI4EOSC OSCAR cluster'
  - url: 'https://inference-walton.cloud.imagine-ai.eu'
    description: 'iMagine OSCAR cluster'
